"""
GÃ©nÃ©rateur de scripts avec Google Gemini API.
"""

import json
from typing import Optional
import google.generativeai as genai
from google.api_core.exceptions import ResourceExhausted, ServiceUnavailable, DeadlineExceeded
from rich.console import Console

from src.utils.retry import with_retry

from src.config import settings
from src.models import Script, VideoFormat

console = Console()


# === PROMPTS PAR FORMAT ===

SYSTEM_PROMPT = """Tu es un expert en copywriting viral pour les rÃ©seaux sociaux franÃ§ais.
Tu crÃ©es des scripts pour des vidÃ©os courtes (20-30 secondes) sur le thÃ¨me des amendes routiÃ¨res.

CONTEXTE NORADAR :
- IA juridique de contestation d'amendes, conÃ§ue par des avocats spÃ©cialisÃ©s
- Prix : 34â‚¬ (ce prix bas est possible parce que tout est automatisÃ©)
- Garantie : 100% remboursÃ© si la contestation Ã©choue
- Process : envoie la photo de ton PV sur Telegram, l'IA fait le reste en 60 secondes
- Gimmick signature : "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TYPES D'AMENDES COUVERTES (radars automatiques uniquement) :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… ExcÃ¨s de vitesse (radar fixe, mobile, tronÃ§on)
âœ… Feu rouge grillÃ©
âœ… Ceinture non attachÃ©e
âœ… TÃ©lÃ©phone au volant
âœ… Franchissement de ligne continue

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AMENDES NON COUVERTES â€” NE JAMAIS MENTIONNER :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ Stationnement
âŒ AlcoolÃ©mie / stupÃ©fiants
âŒ ContrÃ´le technique
âŒ Amendes dressÃ©es manuellement par un agent

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃˆGLES ABSOLUES â€” NE JAMAIS MENTIONNER :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ La mÃ©thode juridique utilisÃ©e (aucun article de loi, pas de L.121-3)
âŒ Comment fonctionne la contestation techniquement
âŒ Les motifs de contestation (vice de procÃ©dure, anomalie, etc.)
âŒ Toute information qui permettrait de contester sans NoRadar
âŒ Les mots "Ã©quipe", "manuel", "on s'occupe", "nous analysons"
âœ… La conclusion doit TOUJOURS Ãªtre POSITIVE : amende annulÃ©e, points gardÃ©s, succÃ¨s confirmÃ©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃˆGLES DE COPYWRITING :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. HOOK (3 sec) : Situation personnelle avec montant prÃ©cis - stopper le scroll
2. TON : Complice, premiÃ¨re personne (POV). Tu racontes TON histoire.
3. DURÃ‰E : 20-30 secondes MAX (150-200 mots)
4. TUTOIEMENT : Utilise "j'" / "tu", jamais "vous" / "nous"
5. CTA : Toujours "lien en bio" + gimmick "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."
6. CONCLUSION POSITIVE OBLIGATOIRE : TOUJOURS finir sur un succÃ¨s ("amende annulÃ©e", "points intacts", "classement sans suite")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃˆGLES POUR LA CONCLUSION / CTA :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- La conclusion doit TOUJOURS Ãªtre POSITIVE et CONFIANTE
- Le narrateur a RÃ‰USSI Ã  contester son amende
- 99% des contestations aboutissent Ã  une annulation
- Le conducteur GARDE ses points
- JAMAIS de doute ("je ne sais pas si...", "on verra bien...", "j'espÃ¨re que...")
- TOUJOURS affirmatif ("Ã§a a marchÃ©", "amende annulÃ©e", "j'ai gardÃ© mes points")

EXEMPLES de bonnes conclusions :
- "RÃ©sultat ? Amende annulÃ©e. Mes points sont intacts."
- "2 semaines plus tard : classement sans suite. 0 point perdu."
- "L'IA a fait le travail. Moi j'ai gardÃ© mon permis."
- "34â‚¬ pour garder mes 4 points ? Meilleur investissement de ma vie."

EXEMPLES de MAUVAISES conclusions (INTERDITES) :
- "Je ne sais pas si Ã§a va marcher..."
- "On verra bien ce que Ã§a donne..."
- "J'espÃ¨re que Ã§a passera..."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DÃ‰TAILS OBLIGATOIRES DANS CHAQUE SCRIPT :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Montant prÃ©cis de l'amende (90â‚¬, 135â‚¬, etc.)
âœ… Type d'infraction radar automatique (excÃ¨s de vitesse, feu rouge, etc.)
âœ… "Photo du PV sur Telegram"
âœ… "60 secondes"
âœ… "34â‚¬, remboursÃ© si Ã§a marche pas"
âœ… Terminer par "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FORMAT DE SORTIE (JSON strict) :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "title": "Titre_Court_Sans_Espaces",
    "hook": "Les 3 premiÃ¨res secondes - accroche",
    "body": "Corps du message - 15-20 secondes",
    "cta": "Call-to-action final - 5 secondes",
    "full_text": "Le texte complet Ã  lire (hook + body + cta)",
    "duration_estimate": 25,
    "hashtags": ["amende", "radar", "contestation", "noradar", "telegram"],
    "thumbnail_text": {
        "line1": "TEXTE LIGNE 1 (5-7 mots max, chiffrÃ©/situation)",
        "line2": "TEXTE LIGNE 2 (3-5 mots max, action/rÃ©sultat)"
    },
    "facebook_caption": "Caption longue pour Facebook (3-5 phrases)"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃˆGLES POUR thumbnail_text (VIGNETTE) :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- line1 : Toujours un FAIT CHIFFRÃ‰ ou SITUATION (ex: "135â‚¬ D'AMENDE", "FLASHÃ‰ Ã€ 137")
- line2 : Toujours une ACTION ou RÃ‰SULTAT (ex: "J'AI PAS PAYÃ‰.", "CONTESTÃ‰E EN 60S.")
- Maximum 7 mots par ligne
- MAJUSCULES uniquement
- Pas de point Ã  la fin de line1
- Point ou point d'exclamation Ã  la fin de line2
- Doit crÃ©er de la CURIOSITÃ‰ (donner envie de regarder la vidÃ©o)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RÃˆGLES POUR facebook_caption :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- 3-5 phrases, ton explicatif mais accessible
- Commencer par une accroche (question ou constat)
- Expliquer briÃ¨vement le service NoRadar
- Bullet points avec Ã©mojis (â†’ ou âœ“)
- Terminer par "Lien en commentaire ðŸ‘‡"
- PAS de hashtags dans la caption Facebook
- JAMAIS mentionner la mÃ©thode juridique
- PAS de sauts de ligne dans le texte, tout sur une seule ligne
- Utiliser des tirets ou â†’ pour sÃ©parer les sections

EXEMPLE facebook_caption :
"ReÃ§u une amende radar ? Avant de payer, regarde Ã§a.

Une IA juridique conÃ§ue par des avocats analyse ton PV et gÃ©nÃ¨re ta contestation en 60 secondes.

â†’ 34â‚¬ tout compris
â†’ RemboursÃ© si Ã§a marche pas
â†’ 100% automatisÃ© sur Telegram

Lien en commentaire ðŸ‘‡"
"""

FORMAT_PROMPTS = {
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NOUVEAUX FORMATS STORY-DRIVEN (PRIORITAIRES)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    VideoFormat.STORY_POV: """FORMAT : STORY POV (Format star - 27% du contenu)
Objectif : Raconter une histoire personnelle de contestation en premiÃ¨re personne

STRUCTURE OBLIGATOIRE :
[HOOK - 0-2s] "J'ai reÃ§u une amende de [montant]â‚¬ pour [infraction radar]."
[TENSION - 2-8s] Contexte, pourquoi c'est frustrant, premier rÃ©flexe de payer
[PIVOT - 8-14s] "Puis j'ai testÃ© NoRadar" â€” Photo PV sur Telegram, 60 secondes
[RÃ‰SULTAT - 14-20s] "RÃ©sultat ? Amende annulÃ©e. 34â‚¬ pour garder mes points ? Meilleur investissement."
[CTA - 20-25s] "Lien en bio. ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

EXEMPLES DE HOOKS POV :
- "J'ai reÃ§u une amende de 90â‚¬ pour excÃ¨s de vitesse la semaine derniÃ¨re."
- "135â‚¬ pour un feu rouge grillÃ© sur l'A6. J'Ã©tais dÃ©goÃ»tÃ©."
- "FlashÃ© Ã  137 au lieu de 130. Mon premier rÃ©flexe ? Payer."
- "TÃ©lÃ©phone au volant. 135â‚¬ + 3 points. J'allais payer..."

TON : Authentique, premiÃ¨re personne, comme si tu racontais Ã  un pote.

Ã‰LÃ‰MENTS OBLIGATOIRES :
- Montant prÃ©cis (90â‚¬, 135â‚¬, etc.)
- Type d'infraction radar automatique
- "Photo du PV sur Telegram"
- "60 secondes"
- "34â‚¬, remboursÃ© si Ã§a marche pas"
- TOUJOURS finir sur un SUCCÃˆS â†’ amende annulÃ©e, points gardÃ©s

EXEMPLES thumbnail_text :
- {"line1": "135â‚¬ D'AMENDE", "line2": "J'AI PAS PAYÃ‰."}
- {"line1": "FLASHÃ‰ Ã€ 137", "line2": "SUR L'A6."}
- {"line1": "90â‚¬ POUR RIEN", "line2": "J'AI CONTESTÃ‰."}
- {"line1": "FEU ROUGE GRILLÃ‰", "line2": "ET ALORS ?"}

NE PAS MENTIONNER : mÃ©thode juridique, article de loi, motifs, Ã©quipe.""",

    VideoFormat.DEBUNK: """FORMAT : DEBUNK (20% du contenu)
Objectif : Casser une idÃ©e reÃ§ue sans rÃ©vÃ©ler la mÃ©thode

STRUCTURE :
[HOOK - 2s] Affirmation contre-intuitive ("J'ai arrÃªtÃ© de payer mes amendes direct")
[CROYANCE - 5s] Ce que les gens pensent Ã  tort
[RÃ‰ALITÃ‰ - 8s] Pourquoi c'est faux (SANS rÃ©vÃ©ler la mÃ©thode)
[SOLUTION - 8s] NoRadar, Telegram, 60 secondes, 34â‚¬
[CTA - 5s] "Lien en bio. ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

EXEMPLES DE HOOKS DEBUNK :
- "J'ai arrÃªtÃ© de payer mes amendes radar direct."
- "Non, t'es pas obligÃ© de payer ton amende."
- "3 raisons de ne pas payer ton amende tout de suite."
- "Tout le monde me dit de payer. Je fais l'inverse."

CROYANCES Ã€ CASSER :
- "On peut pas contester" â†’ Faux
- "C'est trop compliquÃ©" â†’ 60 secondes sur Telegram
- "Ã‡a sert Ã  rien" â†’ Faux
- "Faut un avocat" â†’ L'IA est conÃ§ue par des avocats

TON : Affirmatif, bienveillant. Tu remets les pendules Ã  l'heure.

EXEMPLES thumbnail_text :
- {"line1": "90% DES GENS", "line2": "FONT CETTE ERREUR."}
- {"line1": "ARRÃŠTE DE PAYER", "line2": "DIRECT."}
- {"line1": "ON T'A MENTI", "line2": "SUR LES AMENDES."}
- {"line1": "TU CROIS QUE", "line2": "T'AS PAS LE CHOIX ?"}

NE PAS MENTIONNER : mÃ©thode, article de loi, motifs juridiques.""",

    VideoFormat.CAS_REEL: """FORMAT : CAS RÃ‰EL (20% du contenu)
Objectif : Raconter un cas type (anonymisÃ©) avec suspense

STRUCTURE :
[HOOK - 2s] "Un conducteur a reÃ§u une amende de [montant]â‚¬ pour [infraction]"
[CONTEXTE - 6s] Circonstances (autoroute, ville, radar automatique)
[RÃ‰ACTION - 5s] "Il allait payer, puis il a dÃ©couvert NoRadar"
[ACTION - 6s] "Photo du PV, Telegram, 60 secondes, dossier gÃ©nÃ©rÃ©"
[RÃ‰SULTAT - 4s] "2 semaines plus tard : amende annulÃ©e. Points intacts."
[CTA - 5s] "MÃªme situation ? Lien en bio. ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

EXEMPLES DE HOOKS CAS RÃ‰EL :
- "Un conducteur a reÃ§u une amende de 135â‚¬ pour un feu rouge grillÃ©."
- "FlashÃ© Ã  92 au lieu de 80 sur une dÃ©partementale."
- "TÃ©lÃ©phone au volant. 135â‚¬ + 3 points."
- "Elle roulait Ã  54 en zone 50. Amende quand mÃªme."

TON : Narratif, factuel. Tu racontes l'histoire de quelqu'un d'autre.

INFRACTIONS RADAR AUTOMATIQUE UNIQUEMENT :
- ExcÃ¨s de vitesse (fixe, mobile, tronÃ§on)
- Feu rouge
- Ceinture
- TÃ©lÃ©phone au volant
- Ligne continue

EXEMPLES thumbnail_text :
- {"line1": "TÃ‰LÃ‰PHONE AU VOLANT", "line2": "135â‚¬ + 3 POINTS."}
- {"line1": "FEU ROUGE GRILLÃ‰", "line2": "DOSSIER ENVOYÃ‰."}
- {"line1": "FLASHÃ‰ Ã€ 92", "line2": "AU LIEU DE 80."}
- {"line1": "54 EN ZONE 50", "line2": "AMENDE QUAND MÃŠME."}

NE PAS MENTIONNER : mÃ©thode, article de loi.""",

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # FORMATS EXISTANTS (FEATURE-DRIVEN)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    VideoFormat.SCANDALE: """FORMAT : SCANDALE / ACCROCHE FORTE (13% du contenu)
Objectif : Stopper le scroll, crÃ©er de l'engagement

ANGLE : Faire rÃ©aliser qu'on peut agir (sans expliquer comment)

EXEMPLES DE HOOKS :
- "T'as dÃ©jÃ  payÃ© une amende en te disant 'j'aurais peut-Ãªtre pu contester' ?"
- "Le systÃ¨me compte sur le fait que tu contestes pas."
- "Ce que 90% des conducteurs ne font jamais avec leurs amendes..."
- "Ils encaissent 2 milliards par an. Et si tu arrÃªtais de payer ?"

TON : Complice, pas indignÃ©. Tu donnes un bon plan, pas une leÃ§on.

Ã‰LÃ‰MENTS Ã€ INCLURE :
- IA juridique conÃ§ue par des avocats spÃ©cialisÃ©s
- 60 secondes sur Telegram, tout est automatisÃ©
- 34â‚¬ seulement (automatisÃ©, pas low-cost)
- RemboursÃ© si Ã§a marche pas
- Terminer par "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

EXEMPLES thumbnail_text :
- {"line1": "ILS COMPTENT", "line2": "SUR TON SILENCE."}
- {"line1": "90% DES GENS", "line2": "PAIENT SANS RÃ‰FLÃ‰CHIR."}
- {"line1": "2 MILLIARDS PAR AN", "line2": "ET TOI ?"}

NE PAS MENTIONNER : mÃ©thode, article de loi, motifs juridiques, Ã©quipe.""",

    VideoFormat.TUTO: """FORMAT : TUTO / SIMPLICITÃ‰ (10% du contenu)
Objectif : Montrer que c'est ultra simple (sans rÃ©vÃ©ler la mÃ©thode)

EXEMPLES DE HOOKS :
- "Contester une amende en 60 secondes ? Je t'explique..."
- "Tu penses que contester c'est galÃ¨re ? Regarde Ã§a..."
- "La faÃ§on la plus simple de contester ton amende..."

STRUCTURE :
1. Hook : "C'est plus simple que tu crois"
2. Process simplifiÃ© : "Tu prends ton PV en photo sur Telegram"
3. Rassurance : "L'IA gÃ©nÃ¨re ta contestation automatiquement"
4. Garantie : "Et si Ã§a marche pas, tu es remboursÃ©"
5. CTA : Lien en bio + "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

TON : PÃ©dagogue accessible. Tu simplifies, tu rassures.

EXEMPLES thumbnail_text :
- {"line1": "60 SECONDES", "line2": "POUR CONTESTER."}
- {"line1": "PHOTO DU PV", "line2": "ET C'EST FAIT."}
- {"line1": "PLUS SIMPLE", "line2": "QUE TU CROIS."}

NE PAS MENTIONNER : ce qu'on fait concrÃ¨tement, les motifs, la mÃ©thode.""",

    VideoFormat.TEMOIGNAGE: """FORMAT : TÃ‰MOIGNAGE / PREUVE SOCIALE
Objectif : CrÃ©dibilitÃ© par l'exemple type de situation

EXEMPLES DE HOOKS :
- "J'y croyais pas du tout au dÃ©but..."
- "Quand j'ai reÃ§u mon amende, j'allais payer direct..."
- "Un pote m'a parlÃ© de cette IA qui conteste les amendes..."

TON : Authentique, naturel. Comme un pote qui raconte.

Ã‰LÃ‰MENTS Ã€ INCLURE :
- Montant de l'amende (90â‚¬, 135â‚¬, etc.)
- "J'ai juste envoyÃ© la photo de mon PV sur Telegram"
- "L'IA a gÃ©nÃ©rÃ© ma contestation en 60 secondes"
- "Et c'Ã©tait que 34â‚¬, remboursÃ© si Ã§a marchait pas"
- RÃ‰SULTAT POSITIF : "Amende annulÃ©e", "Points intacts", "Classement sans suite"

EXEMPLES thumbnail_text :
- {"line1": "J'Y CROYAIS PAS", "line2": "ET POURTANT."}
- {"line1": "135â‚¬ D'AMENDE", "line2": "J'AI TESTÃ‰."}
- {"line1": "UN POTE M'A DIT", "line2": "TESTE Ã‡A."}

NE PAS MENTIONNER : pourquoi Ã§a a marchÃ©, la mÃ©thode, les motifs.""",

    VideoFormat.MYTHE: """FORMAT : MYTHE / CROYANCE Ã€ CASSER
Objectif : Ã‰duquer sans rÃ©vÃ©ler la mÃ©thode

EXEMPLES DE HOOKS :
- "Non, t'es pas obligÃ© de payer ton amende..."
- "'Contester Ã§a sert Ã  rien' - C'est faux..."
- "On t'a fait croire que contester c'Ã©tait compliquÃ©..."

STRUCTURE :
1. Le mythe que les gens croient
2. Pourquoi c'est faux (sans dÃ©tailler la mÃ©thode)
3. La solution simple : NoRadar
4. CTA + "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

TON : Bienveillant mais affirmatif.

EXEMPLES thumbnail_text :
- {"line1": "TU CROIS QUE", "line2": "C'EST COMPLIQUÃ‰ ?"}
- {"line1": "MYTHE", "line2": "DÃ‰TRUIT."}
- {"line1": "ON T'A MENTI", "line2": "VOICI LA VÃ‰RITÃ‰."}

NE PAS MENTIONNER : les vraies raisons juridiques, les articles de loi.""",

    VideoFormat.CHIFFRE_CHOC: """FORMAT : CHIFFRE CHOC (10% du contenu)
Objectif : Hook ultra-rapide par un chiffre

EXEMPLES DE HOOKS :
- "34â‚¬. C'est tout ce que Ã§a coÃ»te de contester ton amende avec une IA..."
- "60 secondes. C'est le temps qu'il faut Ã  l'IA pour gÃ©nÃ©rer ta contestation..."
- "RemboursÃ©. Si la contestation marche pas, tu paies rien..."

DURÃ‰E : 15-20 secondes max. Court et percutant.

STRUCTURE :
1. Le chiffre (hook)
2. Ce que Ã§a signifie (5 sec)
3. Comment en profiter : NoRadar (5 sec)
4. CTA rapide + "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

EXEMPLES thumbnail_text :
- {"line1": "34â‚¬", "line2": "TOUT COMPRIS."}
- {"line1": "60 SECONDES", "line2": "CHRONO."}
- {"line1": "REMBOURSÃ‰", "line2": "SI Ã‡A MARCHE PAS."}

NE PAS MENTIONNER : statistiques de succÃ¨s prÃ©cises, mÃ©thode.""",

    VideoFormat.ULTRA_COURT: """FORMAT : ULTRA COURT (15 secondes max)
Objectif : Message percutant en 50-70 mots maximum

EXEMPLES DE HOOKS :
- "Amende ? L'IA conteste en 60 secondes."
- "34â‚¬. AutomatisÃ©. RemboursÃ© si Ã§a marche pas."
- "Photo du PV â†’ l'IA gÃ©nÃ¨re ta contestation."

DURÃ‰E : 15 secondes MAX (50-70 mots)

STRUCTURE :
1. Hook (2 sec)
2. Promesse (5 sec)
3. CTA (3 sec) + "ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

TON : Direct, efficace. Pas de blabla.

EXEMPLES thumbnail_text :
- {"line1": "AMENDE ?", "line2": "60 SECONDES."}
- {"line1": "34â‚¬", "line2": "REMBOURSÃ‰."}
- {"line1": "PHOTO DU PV", "line2": "C'EST TOUT."}

NE PAS MENTIONNER : dÃ©tails, mÃ©thode, justification.""",

    VideoFormat.VRAI_FAUX: """FORMAT : VRAI OU FAUX (12-15 secondes)
Objectif : Engagement maximum via un format interactif qui pousse aux commentaires

STRUCTURE STRICTE :
1. HOOK (2 sec) : "VRAI ou FAUX :" + affirmation provocante sur les amendes/radars/permis
2. PAUSE (1 sec) : "La rÃ©ponse va te surprendre..." ou "RÃ©flÃ©chis bien..." ou "Tu es sÃ»r de toi ?"
3. RÃ‰PONSE (3 sec) : "C'est FAUX !" ou "C'est VRAI !" + explication flash en 1 phrase
4. LIEN NORADAR (3 sec) : Relier naturellement Ã  NoRadar comme solution
5. CTA (3 sec) : "Lien en bio. ConÃ§u par des avocats. ExÃ©cutÃ© par une IA."

EXEMPLES D'AFFIRMATIONS (varier Ã  chaque gÃ©nÃ©ration, NE JAMAIS rÃ©utiliser) :
- "VRAI ou FAUX : Tu es obligÃ© de payer une amende radar dans les 45 jours"
- "VRAI ou FAUX : Si tu contestes, tu risques de payer plus cher"
- "VRAI ou FAUX : Un excÃ¨s de 1 km/h peut te coÃ»ter des points"
- "VRAI ou FAUX : Une amende payÃ©e ne peut plus Ãªtre contestÃ©e"
- "VRAI ou FAUX : Les radars ont une marge d'erreur obligatoire"
- "VRAI ou FAUX : Contester une amende, c'est rÃ©servÃ© aux riches"
- "VRAI ou FAUX : Tu peux recevoir une amende sans Ãªtre flashÃ©"
- "VRAI ou FAUX : Le propriÃ©taire du vÃ©hicule paie toujours l'amende"

TON : MystÃ©rieux au dÃ©but, affirmatif Ã  la rÃ©ponse. Pousser les gens Ã  commenter leur rÃ©ponse.

DURÃ‰E : 12-15 secondes MAX (50-80 mots)

RÃˆGLE CLÃ‰ : L'affirmation doit Ãªtre suffisamment ambiguÃ« pour que 50% des gens se trompent.

NE PAS MENTIONNER : articles de loi, mÃ©thode juridique, motifs de contestation, Ã©quipe humaine.""",
}


class ScriptGenerator:
    """GÃ©nÃ¨re des scripts vidÃ©o via Gemini API."""

    def __init__(self):
        if not settings.gemini_api_key:
            raise ValueError("GEMINI_API_KEY non configurÃ©e dans .env")

        genai.configure(api_key=settings.gemini_api_key)
        self.model = genai.GenerativeModel(settings.gemini_model)

    @with_retry(exceptions=(ResourceExhausted, ServiceUnavailable, DeadlineExceeded))
    def _call_gemini_api(self, prompts, generation_config):
        """Appel API Gemini avec retry automatique."""
        return self.model.generate_content(prompts, generation_config=generation_config)

    def generate(
        self,
        format: VideoFormat,
        theme: Optional[str] = None,
        custom_instructions: Optional[str] = None,
    ) -> Script:
        """
        GÃ©nÃ¨re un script pour le format spÃ©cifiÃ©.

        Args:
            format: Le format de vidÃ©o (SCANDALE, TUTO, etc.)
            theme: ThÃ¨me spÃ©cifique optionnel
            custom_instructions: Instructions additionnelles

        Returns:
            Script gÃ©nÃ©rÃ©
        """
        # Construction du prompt
        format_prompt = FORMAT_PROMPTS[format]
        user_prompt = f"{format_prompt}\n\n"

        if theme:
            user_prompt += f"THÃˆME SPÃ‰CIFIQUE : {theme}\n\n"

        if custom_instructions:
            user_prompt += f"INSTRUCTIONS ADDITIONNELLES : {custom_instructions}\n\n"

        user_prompt += "GÃ©nÃ¨re UN script au format JSON demandÃ©. Rappel : ne JAMAIS mentionner la mÃ©thode juridique."

        console.print(f"[blue]GÃ©nÃ©ration script {format.value}...[/blue]")

        try:
            response = self._call_gemini_api(
                [SYSTEM_PROMPT, user_prompt],
                generation_config=genai.GenerationConfig(
                    max_output_tokens=settings.gemini_max_tokens,
                    temperature=0.8,  # CrÃ©ativitÃ©
                ),
            )

            # Extraction du JSON
            response_text = response.text.strip()

            # Nettoyer si wrapped dans ```json
            if response_text.startswith("```"):
                response_text = response_text.split("```")[1]
                if response_text.startswith("json"):
                    response_text = response_text[4:]
            response_text = response_text.strip()

            # Parser le JSON
            data = json.loads(response_text)

            script = Script(
                format=format,
                title=data["title"],
                hook=data["hook"],
                body=data["body"],
                cta=data["cta"],
                full_text=data["full_text"],
                duration_estimate=data.get("duration_estimate", 25),
                hashtags=data.get("hashtags", []),
                thumbnail_text=data.get("thumbnail_text", {"line1": "", "line2": ""}),
                facebook_caption=data.get("facebook_caption", ""),
            )

            console.print(f"[green]âœ“ Script gÃ©nÃ©rÃ© : {script.title}[/green]")
            return script

        except json.JSONDecodeError as e:
            console.print(f"[red]Erreur parsing JSON : {e}[/red]")
            console.print(f"[dim]RÃ©ponse brute : {response_text[:500]}...[/dim]")
            raise
        except Exception as e:
            console.print(f"[red]Erreur gÃ©nÃ©ration : {e}[/red]")
            raise

    def generate_batch(
        self,
        formats: dict[VideoFormat, int],
        theme: Optional[str] = None,
    ) -> list[Script]:
        """
        GÃ©nÃ¨re un batch de scripts selon la distribution demandÃ©e.

        Args:
            formats: Dict {format: nombre} ex: {SCANDALE: 5, TUTO: 3}
            theme: ThÃ¨me optionnel pour tous les scripts

        Returns:
            Liste de scripts gÃ©nÃ©rÃ©s
        """
        scripts = []

        for format, count in formats.items():
            console.print(f"\n[bold]GÃ©nÃ©ration {count}x {format.value}[/bold]")
            for i in range(count):
                try:
                    script = self.generate(format, theme)
                    scripts.append(script)
                    console.print(f"  [{i + 1}/{count}] {script.title}")
                except Exception as e:
                    console.print(f"  [red][{i + 1}/{count}] Ã‰chec : {e}[/red]")

        console.print(f"\n[green]Total : {len(scripts)} scripts gÃ©nÃ©rÃ©s[/green]")
        return scripts

    def save_script(self, script: Script) -> str:
        """Sauvegarde un script en JSON."""
        settings.ensure_directories()
        output_path = settings.output_dir / "scripts" / script.filename

        with open(output_path, "w", encoding="utf-8") as f:
            f.write(script.model_dump_json(indent=2))

        console.print(f"[dim]SauvegardÃ© : {output_path}[/dim]")
        if settings.tracking_enabled:
            console.print(f"[cyan]ðŸ”— Lien trackable : {script.telegram_link}[/cyan]")
        return str(output_path)

    @staticmethod
    def load_script(path: str) -> Script:
        """Charge un script depuis un fichier JSON."""
        with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)
        return Script(**data)
